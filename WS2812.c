
#include <stdint.h>
#include <avr/io.h>
#include <util/delay.h>
#include "WS2812.h"


const uint32_t word_mask[] = {
  0b000000000000000010000000,
  0b000000000000000001000000,
  0b000000000000000000100000,
  0b000000000000000000010000,
  0b000000000000000000001000,
  0b000000000000000000000100,
  0b000000000000000000000010,
  0b000000000000000000000001,
  0b000000001000000000000000,
  0b000000000100000000000000,
  0b000000000010000000000000,
  0b000000000001000000000000,
  0b000000000000100000000000,
  0b000000000000010000000000,
  0b000000000000001000000000,
  0b000000000000000100000000,
  0b100000000000000000000000,
  0b010000000000000000000000,
  0b001000000000000000000000,
  0b000100000000000000000000,
  0b000010000000000000000000,
  0b000001000000000000000000,
  0b000000100000000000000000,
  0b000000010000000000000000
};

void ws2812_setup() { 
  DDRB |= 1 << 0;
}

void ws2812_send(const struct LED *data, uint8_t len) {
  for (uint8_t i = 0; i < len; i++) {
    uint32_t led_word = 0;
    led_word = data[i].g;
    led_word += data[i].r * 256;
    led_word += data[i].b * 65536;
    for (uint8_t i = 0; i < 24; i++) {
      if (led_word & word_mask[i]) {
        PORTB |= (1 << 0);
        asm("nop");
        asm("nop");
        asm("nop");
        PORTB &= ~(1 << 0);
        asm("nop");
      } else {
        PORTB |= (1 << 0);
        asm("nop");
        PORTB &= ~(1 << 0);
        asm("nop");
      }
    }
  }
}

void ws2812_wait() {
  _delay_ms(40);
}
